// CA-1011, message-message race between key range declaration of one node and network inquiry of the second.
// sbt "run-main edu.berkeley.cs.boom.molly.SyncFTChecker --nodes N1,N2,N3 --EOT 8 --EFF 6 --crashes 1 --prov-diagrams src/test/resources/examples_ft/nemo/CA-1011-key-range.ded"


// Logic.

seq(Node, Val)@next :- seq(Node, Val), notin req(Node, _);
seq(Node, Val+1)@next :- seq(Node, Val), req(Node, _);

timerr(Agent, Node, 0) :- begin(Agent, Node);
timerr(Agent, Node, 0) :- retry(Agent, Node);
timerr(Agent, Node, V+1)@next :- timerr(Agent, Node, V), notin retry(Agent, _);

retry(Agent, Node) :- timerr(Agent, Node, V), V > 1, notin resp(Agent, _);

req(Node, Agent)@async :- begin(Agent, Node);
req(Node, Agent)@async :- retry(Agent, Node);

resp(Agent, Val)@async :- req(Node, Agent), seq(Node, Val);
resp(Agent, Val)@next :- resp(Agent, Val);

count_resp(Agent, Val, count<Val>) :- resp(Agent, Val);

// same(Node, Other, Val) :- resp(Node, Val), resp(Other, Val), Node != Other;

diff_ctr(Node, Other, 0) :- diff_ctr_start(Node, Other);
diff_ctr(Node, Other, Ctr)@next :- diff_ctr(Node, Other, Ctr);
diff_ctr(Node, Other, Ctr+1)@next :- diff_ctr(Node, Other, Ctr), resp(Node, Val), resp(Other, Val), Node != Other;

count_diff_ctr(Node, Other, count<Ctr>) :- diff_ctr(Node, Other, Ctr);


// Correctness specification.

pre(Node) :- resp(Node, _);
// post(Node) :- resp(Node, Val), notin same(Node, Other, _);
post(Node) :- resp(Node, Val), count_diff_ctr(Node, Other, Ctr), Ctr == 1, Node != Other;


// Init.

seq("N1", 1)@1;
begin("N2", "N1")@1;
begin("N3", "N1")@3;
diff_ctr_start("N2", "N3")@1;
diff_ctr_start("N3", "N2")@1;
