include "util/timeout_svc.ded";

timer_svc(G, G, 2) :- group(G, G)@1;

// "establish Group membership" as a replica
member(G, M)@async :- begin(M), group(M, G);
clients(G, C)@async :- client(C), group(M, G);

member(G,M) :- cchange(M, "A"), group(G, G);
member(G, M)@next :- member(G, M), notin cchange(M, "D"), group(G, G);

primary(G, L)@next :- group(G, G), primary(G, L), notin primary_change(G, _);
primary(G, Node)@next :- group(G, G), primary_change(G, Node);
primary_change(G, Node) :- group(G, G), promote(G, Node), primary(G, Primary), Node != Primary;

clients(G, C)@next :- clients(G, C);
group(M, G)@next :- group(M, G);

// periodically tell clients and replicas about membership and primaryship
member(C, M)@async :- member(G, M), clients(G, C), group(G, G), timeout(G, G);
member(A, M)@async :- member(G, A), member(G, M), group(G, G), timeout(G, G);
primary(M, L)@async :- primary(G, L), member(G, M), group(G, G), timeout(G, G);
primary(M, L)@async :- primary(G, L), clients(G, M), group(G, G), timeout(G, G);

cchange("c", "D")@2;
cchange("c", "A")@6;
//promote("G", "b")@5;
