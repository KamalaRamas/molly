// "establish Group membership" as a replica
member(G, M)@async :- begin(M), group(M, G);

member(G,M) :- cchange(G, M, "A"), group(G, G);
member(G, M)@next :- member(G, M), notin cchange(G, M, "D"), group(G, G);
member(C, M)@next :- member(G, M), clients(G, C), group(G, G);
member(A, M)@next :- member(G, A), member(G, M), group(G, G);

primary(G, L)@next :- group(G, G), primary(G, L), notin primary_change(G, _);
primary(G, Node)@next :- group(G, G), primary_change(G, Node);
primary_change(G, Node) :- group(G, G), promote(G, Node), primary(G, Primary), Node != Primary;
cchange(G, Primary, "D") :- group(G, G), promote(G, Node), primary(G, Primary), Node != Primary;
primary(M, L)@next :- primary(G, L), member(G, M), group(G, G);
primary(M, L)@next :- primary(G, L), clients(G, M), group(G, G);

clients(G, C)@async :- client(C), group(C, G);
clients(G, C)@next :- clients(G, C);
new_clients(C) :- clients(G, C);

//cchange("G", "c", "D")@1;
//cchange("G", "c", "A")@6;
cchange("G", M, "D")@next :- cchange("G", M, "D"), notin cchange("G", M, "A");
//promote("G", "b")@3;
